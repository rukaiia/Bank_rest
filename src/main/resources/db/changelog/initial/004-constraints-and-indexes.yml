databaseChangeLog:
  - changeSet:
      id: constraints and indexes
      author: rukaiia
      changes:
        - sql:
            sql: |
              ALTER TABLE cards DROP CONSTRAINT IF EXISTS chk_cards_balance;
              ALTER TABLE cards DROP CONSTRAINT IF EXISTS chk_cards_expiry;
              ALTER TABLE cards DROP CONSTRAINT IF EXISTS chk_cards_status;
              ALTER TABLE transfers DROP CONSTRAINT IF EXISTS chk_transfers_amount;

              UPDATE cards
              SET expiry_date = CURRENT_DATE
              WHERE expiry_date < CURRENT_DATE;

              ALTER TABLE cards ADD CONSTRAINT chk_cards_balance CHECK (balance >= 0);
              ALTER TABLE cards ADD CONSTRAINT chk_cards_expiry CHECK (expiry_date >= CURRENT_DATE);
              ALTER TABLE cards ADD CONSTRAINT chk_cards_status CHECK (status IN ('ACTIVE','BLOCKED','EXPIRED'));
              ALTER TABLE transfers ADD CONSTRAINT chk_transfers_amount CHECK (amount > 0);

              CREATE INDEX IF NOT EXISTS idx_cards_owner ON cards(owner_id);
              CREATE INDEX IF NOT EXISTS idx_cards_status ON cards(status);
              CREATE INDEX IF NOT EXISTS idx_cards_last4 ON cards(masked_number);

              CREATE INDEX IF NOT EXISTS idx_transfers_date ON transfers(created_at);
              CREATE INDEX IF NOT EXISTS idx_transfers_from ON transfers(from_card_id);
